{% extends "base.html" %}

{% block content %}
    <!-- Modern Minimalist Navigation Menu -->
    <div id="fab-nav" style="position: fixed; top: 30px; left: 30px; z-index: 9999;">
        <button id="fab-toggle" style="background: #247ba0; color: white; border-radius: 12px; width: 70px; height: 70px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; font-size: 18px; border: none; cursor: pointer; transition: all 0.2s ease;">
            <span id="fab-icon" style="transition: transform 0.2s ease;">☰</span>
        </button>
    </div>

    <!-- Sticky Navigation Menu -->
    <div id="sticky-nav" style="position: fixed; top: 50px; left: 50px; z-index: 9998; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 20px; min-width: 240px; display: none; border: 1px solid #e5e7eb;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: #247ba0; text-transform: uppercase; letter-spacing: 0.05em;">Navigation</div>
            <button id="nav-toggle" style="background: #6b7280; color: white; border-radius: 6px; padding: 6px 10px; font-size: 12px; border: none; cursor: pointer; transition: all 0.2s ease;">
                ✕
            </button>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 2px;">
      
            
            <a href="#metric-cards" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">Số liệu tổng quan</span>
            </a>
            
            
            <a href="#campaigns-table" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">Danh sách Chiến dịch</span>
            </a>
            
            <a href="#daily-tracking" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">REPORT SOCIAL MEDIA - DETAIL</span>
            </a>
            
            <a href="#pivot-advanced" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">REPORT SOCIAL MEDIA - OVERVIEW</span>
            </a>
            
            <a href="#meta-report-insights" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">TRACKING META REPORT INSIGHT</span>
            </a>
            
            <a href="#agency-report-section" class="nav-link" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; font-size: 14px; color: #247ba0; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; background: transparent;">
                <span style="width: 6px; height: 6px; background: #9ca3af; border-radius: 50%;"></span>
                <span style="font-weight: 400;">REPORT ĐẠI LÝ</span>
            </a>
        </div>
    </div>

    {% include 'components/global-filters.html' %}
    {% include 'components/metric-cards.html' %}
    {% include 'components/charts-section.html' %}
    {% include 'components/campaigns-table.html' %}
    {% include 'components/daily-tracking.html' %}
    {% include 'components/pivot-advanced.html' %}
    {% include 'components/meta-report-insights.html' %}
    {% include 'components/insights-panel.html' %}
{% endblock %}

{% block extra_scripts %}
<script>
// Simple Navigation Menu JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('Navigation script starting...');
    
    const fabNav = document.getElementById('fab-nav');
    const stickyNav = document.getElementById('sticky-nav');
    const fabToggle = document.getElementById('fab-toggle');
    const navToggle = document.getElementById('nav-toggle');
    const navLinks = document.querySelectorAll('.nav-link');
    
    console.log('Elements found:', {
        fabNav: !!fabNav,
        stickyNav: !!stickyNav,
        fabToggle: !!fabToggle,
        navToggle: !!navToggle,
        navLinks: navLinks.length
    });
    
    let isMenuOpen = false;
    
    // Toggle menu function
    function toggleMenu() {
        console.log('Toggle menu clicked, current state:', isMenuOpen);
        isMenuOpen = !isMenuOpen;
        
        if (isMenuOpen) {
            stickyNav.style.display = 'block';
            fabNav.style.display = 'none';
            navToggle.innerHTML = '✕';
            console.log('Menu opened');
        } else {
            stickyNav.style.display = 'none';
            fabNav.style.display = 'block';
            navToggle.innerHTML = '☰';
            console.log('Menu closed');
        }
    }
    
    // Smooth scroll function
    function smoothScrollTo(targetId) {
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            const offsetTop = targetElement.offsetTop - 100;
            window.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });
            
            // Close menu after clicking
            if (isMenuOpen) {
                toggleMenu();
            }
        }
    }
    
    // Add event listeners
    if (fabToggle) {
        fabToggle.addEventListener('click', toggleMenu);
        console.log('FAB listener added');
    }
    
    if (navToggle) {
        navToggle.addEventListener('click', toggleMenu);
        console.log('Nav toggle listener added');
    }
    
    // Handle nav link clicks
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            console.log('Navigating to:', targetId);
            smoothScrollTo(targetId);
        });
    });
    
    // Clean hover effects for nav links
    navLinks.forEach(link => {
        link.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f7ff';
            this.style.color = '#247ba0';
            this.style.fontWeight = '500';
            
            // Animate dot
            const dot = this.querySelector('span:first-child');
            if (dot) {
                dot.style.backgroundColor = '#247ba0';
                dot.style.transform = 'scale(1.2)';
            }
        });
        
        link.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'transparent';
            this.style.color = '#247ba0';
            this.style.fontWeight = '400';
            
            // Reset dot
            const dot = this.querySelector('span:first-child');
            if (dot) {
                dot.style.backgroundColor = '#9ca3af';
                dot.style.transform = 'scale(1)';
            }
        });
    });
    
    // FAB hover effects
    if (fabToggle) {
        fabToggle.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#1a5f7a';
            this.style.transform = 'scale(1.05)';
            this.style.boxShadow = '0 6px 16px rgba(36, 123, 160, 0.3)';
        });
        
        fabToggle.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#247ba0';
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
    }
    
    console.log('Navigation setup complete');
});

</script>
<script>
    // Wire buttons and event listeners
    document.addEventListener('DOMContentLoaded',()=>{
        // Initialize daily tracking
        if (typeof initializeDailyTracking === 'function') {
            initializeDailyTracking();
        }
        
        // Initialize meta report insights
        if (typeof initializeMetaReportInsights === 'function') {
            initializeMetaReportInsights();
        }
        let currentCampaign='';
        const patchView=window.viewInsights;
        
        function highlight(kind){
            const a=document.getElementById('btn-break-placement');
            const b=document.getElementById('btn-break-age');
            const c=document.getElementById('btn-break-country');
            [a,b,c].forEach(x=>{ 
                if(!x) return; 
                x.classList.remove('btn-primary','text-white'); 
                x.style.backgroundColor=''; 
                x.style.color='#247ba0'; 
                x.classList.add('border'); 
            });
            const map={placement:a,age_gender:b,country:c};
            const btn=map[kind]; 
            if(btn){ 
                btn.classList.remove('border'); 
                btn.classList.add('btn-primary','text-white'); 
                btn.style.color='#fff'; 
            }
        }
        
        function applyFilters(data){
            const fs=document.getElementById('filter-status').value;
            const fo=document.getElementById('filter-objective').value;
            let items=data.campaigns.slice();
            if(fs!=='ALL') items=items.filter(x=>x.status===fs);
            if(fo!=='ALL') items=items.filter(x=>x.objective===fo);
            updateCampaignsTable(items);
            createCharts(items);
        }
        
        // populate objective options after load
        const oldLoad=window.loadAdsData;
        window.loadAdsData=async ()=>{ 
            await oldLoad(); 
            if(!adsData||!adsData.campaigns) return; 
            const sel=document.getElementById('filter-objective'); 
            const set=[...new Set(adsData.campaigns.map(c=>c.objective))]; 
            sel.innerHTML='<option value="ALL" selected>Tất cả</option>'+set.map(o=>`<option value="${o}">${o}</option>`).join(''); 
            applyFilters(adsData); 
        }
        
        document.getElementById('filter-status').onchange=()=>applyFilters(adsData);
        document.getElementById('filter-objective').onchange=()=>applyFilters(adsData);
        
        // Close insights panel
        document.getElementById('close-insights').addEventListener('click', () => { 
            document.getElementById('insights-panel').classList.add('hidden'); 
        });
        document.getElementById('btn-export-campaigns').onclick=()=>{ 
            const rows=(adsData?.campaigns||[]).map(c=>({
                id:c.campaign_id,
                name:c.campaign_name,
                status:c.status,
                objective:c.objective,
                created:c.created_time,
                start:c.start_time,
                stop:c.stop_time
            })); 
            const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'}); 
            const url=URL.createObjectURL(blob); 
            const a=document.createElement('a'); 
            a.href=url; 
            a.download='campaigns.csv'; 
            a.click(); 
            URL.revokeObjectURL(url); 
        };
        
        // AI Analysis button
        document.getElementById('btn-ai-analysis').onclick = () => {
            if (currentCampaign) {
                // Disable button during analysis
                const btn = document.getElementById('btn-ai-analysis');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = 'Đang phân tích...';
                
                performAIAnalysis(currentCampaign).finally(() => {
                    // Re-enable button
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            } else {
                alert('Vui lòng chọn một campaign trước khi phân tích AI');
            }
        };
        
        window.viewInsights=async (campaignId,status)=>{
            currentCampaign=campaignId; 
            resetAIState(); // Reset AI state when viewing new campaign
            await patchView(campaignId,status);
            const note=document.getElementById('insights-note'); 
            if(note){ 
                note.classList.add('hidden'); 
                note.textContent=''; 
            }
            const load=(kind)=>{ 
                highlight(kind); 
                const box=document.getElementById('breakdownChart').parentElement; 
                box.classList.add('loading-pulse'); 
                fetchBreakdown(currentCampaign,kind).then(d=>{ 
                    box.classList.remove('loading-pulse'); 
                    if(d.token_expired){ 
                        alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); 
                        return; 
                    } 
                    if(!d.error) renderBreakdown(kind,d.rows||[]); 
                    else console.warn('Breakdown error', d.error); 
                }); 
            };
            document.getElementById('btn-break-placement').onclick=()=>load('placement');
            document.getElementById('btn-break-age').onclick=()=>load('age_gender');
            document.getElementById('btn-break-country').onclick=()=>load('country');
            document.getElementById('date-preset').onchange=()=>{ 
                const v=document.getElementById('date-preset').value; 
                const show=v==='custom'; 
                ['since','until','range-sep','apply-range'].forEach(id=>{ 
                    const el=document.getElementById(id); 
                    if(el){ el.classList.toggle('hidden',!show);} 
                }); 
                if(!show){ 
                    load('placement'); 
                    fetchAds(currentCampaign).then(d=>{ 
                        if(!d.error) renderCreatives(d.items||[]); 
                    }); 
                } 
            };
            document.getElementById('apply-range').onclick=()=>{ 
                load('placement'); 
                fetchAds(currentCampaign).then(d=>{ 
                    if(d.token_expired){ 
                        alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); 
                        return; 
                    } 
                    if(!d.error) renderCreatives(d.items||[]); 
                }); 
            };
            load('placement');
            fetchAds(currentCampaign).then(d=>{ 
                if(d.token_expired){ 
                    alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); 
                    return; 
                } 
                if(!d.error) renderCreatives(d.items||[]); 
            })
        }
    });
</script>
<!-- Modal for enlarged pie chart -->
<div id="pivot-pie-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-3xl w-11/12 p-4 relative">
    <button id="pivot-pie-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">✕</button>
    <h3 id="pivot-pie-title" class="text-lg font-semibold mb-3">Biểu đồ</h3>
    <div class="h-[420px]"><canvas id="pivot-pie-modal-canvas"></canvas></div>
  </div>
  
</div>
{% endblock %}
