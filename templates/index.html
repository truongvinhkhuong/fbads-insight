<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary:#247ba0; }
        .brand { color: var(--primary); }
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover { filter: brightness(0.95); }
        .chip { background-color: rgba(36,123,160,.1); color:#0f3e52; }
        .chatbot-toggle { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .chatbot-container { position: fixed; bottom: 80px; right: 20px; z-index: 999; display: none; }
        .chatbot-messages { max-height: 400px; overflow-y: auto; }
        .message { margin: 8px 0; padding: 8px 12px; border-radius: 8px; }
        .user-message { background-color: var(--primary); color: white; margin-left: 20px; }
        .bot-message { background-color: #f3f4f6; color: #374151; margin-right: 20px; }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-5">
                <div>
                    <h1 class="text-2xl font-bold brand">Facebook Ads Dashboard</h1>
                    <p class="text-gray-600">Phân tích hiệu suất quảng cáo Facebook</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Cập nhật:</p>
                    <p id="last-update" class="text-sm font-medium text-gray-900">Đang tải...</p>
                    <button id="btn-refresh" class="mt-2 px-3 py-1 text-white rounded btn-primary text-sm">Cập nhật dữ liệu</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="ml-4">
                        <div class="text-sm text-gray-500">Tổng số chiến dịch</div>
                        <div id="total-campaigns" class="text-xl font-semibold">0</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="ml-4">
                        <div class="text-sm text-gray-500">Đang hoạt động</div>
                        <div id="active-campaigns" class="text-xl font-semibold">0</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border border-gray-100">
                <div class="flex items-center">
                    <div class="ml-4">
                        <div class="text-sm text-gray-500">Tạm dừng/khác</div>
                        <div id="paused-campaigns" class="text-xl font-semibold">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-lg shadow p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Số chiến dịch theo Mục tiêu</h3>
                </div>
                <div style="height:300px"><canvas id="objectiveChart"></canvas></div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Số chiến dịch theo Trạng thái</h3>
                </div>
                <div style="height:300px"><canvas id="statusChart"></canvas></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Danh sách Chiến dịch</h3>
                <div class="flex items-center gap-2 text-sm">
                    <label>Status</label>
                    <select id="filter-status" class="border px-2 py-1 rounded">
                        <option value="ALL" selected>Tất cả</option>
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="PAUSED">PAUSED</option>
                        <option value="ARCHIVED">ARCHIVED</option>
                    </select>
                    <label class="ml-3">Objective</label>
                    <select id="filter-objective" class="border px-2 py-1 rounded">
                        <option value="ALL" selected>Tất cả</option>
                    </select>
                    <button id="btn-export-campaigns" class="ml-3 px-3 py-1 rounded border" style="border-color:#247ba0;color:#247ba0;">Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto table-vertical-scroll">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên Chiến dịch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mục tiêu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Start</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Insights</th>
                        </tr>
                    </thead>
                    <tbody id="campaigns-table" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Daily Tracking Section -->
        <div class="bg-white rounded-lg shadow mt-8 border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Tracking Ads Chi Tiết</h3>
                    <p class="text-sm text-gray-600">Daily Tracking - Bảng tổng quan về tài khoản với 25 metrics quan trọng</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 text-sm">
                        <label>Khoảng thời gian:</label>
                        <select id="daily-date-preset" class="border px-2 py-1 rounded">
                            <option value="last_7d" selected>7 ngày</option>
                            <option value="last_30d">30 ngày</option>
                            <option value="last_90d">90 ngày</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <button onclick="refreshBudgetCache()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition text-sm" title="Cập nhật dữ liệu ngân sách từ Facebook API">
                        Cập nhật Ngân sách
                    </button>
                    <button id="btn-refresh-daily" class="px-3 py-1 text-white rounded btn-primary text-sm">Cập nhật</button>
                    <button id="btn-export-daily" class="px-3 py-1 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;">Export CSV</button>
                </div>
            </div>
            
            <!-- Daily Metrics Summary Cards -->
            <div class="p-6 border-b border-gray-200">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-xs text-blue-600 font-medium">Tổng chi tiêu</div>
                        <div id="daily-total-spend" class="text-lg font-bold text-blue-800">$0</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="text-xs text-green-600 font-medium">Tổng Reach</div>
                        <div id="daily-total-reach" class="text-lg font-bold text-green-800">0</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="text-xs text-purple-600 font-medium">Tổng Impressions</div>
                        <div id="daily-total-impressions" class="text-lg font-bold text-purple-800">0</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <div class="text-xs text-orange-600 font-medium">CTR Trung bình</div>
                        <div id="daily-avg-ctr" class="text-lg font-bold text-orange-800">0%</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4">
                        <div class="text-xs text-red-600 font-medium">CPC Trung bình</div>
                        <div id="daily-avg-cpc" class="text-lg font-bold text-red-800">$0</div>
                    </div>
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <div class="text-xs text-indigo-600 font-medium">CPM Trung bình</div>
                        <div id="daily-avg-cpm" class="text-lg font-bold text-indigo-800">$0</div>
                    </div>
                </div>
            </div>

            <!-- Daily Pivot Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Ngày</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phân phối</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng chi tiêu</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Khoản tiền tối đa mà bạn sẵn lòng chi tiêu cho chiến dịch hoặc nhóm quảng cáo, trung bình mỗi ngày hoặc trong toàn bộ thời gian chạy chiến dịch/quảng cáo đó. Cột này không áp dụng cho quảng cáo, chỉ áp dụng cho nhóm quảng cáo và chiến dịch. Hiển thị '-' nếu budget được set ở ad set level thay vì campaign level.">Ngân sách</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reach</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impressions</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tần suất</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kết quả</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPC</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người liên hệ nhắn tin</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người liên hệ nhắn tin mới</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROAS</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CTR</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engagement</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Clicks</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link CTR</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link CPC</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video Views</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo Views</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPE</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video 2s+</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Value</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaigns</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tracking-table" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="24" class="px-6 py-4 text-center text-gray-500">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Row -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Tổng hợp kết quả</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>Tổng chi tiêu: <span id="summary-total-spend" class="font-medium">$0</span></div>
                            <div>Tổng Reach: <span id="summary-total-reach" class="font-medium">0</span></div>
                            <div id="campaign-status" class="text-xs text-blue-600 hidden">Đang tải...</div>
                            <div>Tổng Impressions: <span id="summary-total-impressions" class="font-medium">0</span></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Chỉ số trung bình</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>CTR trung bình: <span id="summary-avg-ctr" class="font-medium">0%</span></div>
                            <div>CPC trung bình: <span id="summary-avg-cpc" class="font-medium">$0</span></div>
                            <div>CPM trung bình: <span id="summary-avg-cpm" class="font-medium">$0</span></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Chuyển đổi</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                    <div>Tổng Người liên hệ nhắn tin: <span id="summary-total-messaging" class="font-medium">0</span></div>
                    <div>Tổng Người liên hệ nhắn tin mới: <span id="summary-total-conversions" class="font-medium">0</span></div>
                            <div>ROAS trung bình: <span id="summary-avg-roas" class="font-medium">0</span></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Giải thích metrics</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div><strong>CTR:</strong> Tỷ lệ nhấp chuột</div>
                            <div><strong>CPC:</strong> Chi phí mỗi click</div>
                            <div><strong>CPM:</strong> Chi phí 1000 lần hiển thị</div>
                            <div><strong>ROAS:</strong> Lợi nhuận/chi phí quảng cáo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pivot nâng cao theo brief -->
        <div class="bg-white rounded-lg shadow mt-8 border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Pivot nâng cao</h3>
                    <p class="text-sm text-gray-600">Các chỉ số: Chi tiêu, Reach, Impressions, New messages, CP New message, Purchase value, Engagement</p>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi tiêu</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reach</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impressions</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người liên hệ nhắn tin mới</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CP Người liên hệ nhắn tin mới</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giá trị chuyển đổi mua</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engagement</th>
                        </tr>
                    </thead>
                    <tbody id="pivot-adv-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Đang tải...</td></tr>
                    </tbody>
                    <tfoot id="pivot-adv-foot"></tfoot>
                </table>
            </div>
            <div class="p-6">
                <div class="h-64">
                    <canvas id="pivot-adv-line"></canvas>
                </div>
            </div>
        </div>

        <!-- Meta Report Insights Section -->
        <div class="bg-white rounded-lg shadow mt-8 border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Tracking Meta Report Insight</h3>
                    <p class="text-sm text-gray-600">Mục tiêu: Tracking Performance mỗi tháng - Đo lường hiệu quả xây kênh fanpage, content</p>
                    <p class="text-xs text-gray-500 mt-1">Dimensions: Thương hiệu, Định dạng nội dung, Thời gian</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 text-sm">
                        <label>Khoảng thời gian:</label>
                        <select id="meta-report-date-preset" class="border px-2 py-1 rounded">
                            <option value="last_30d" selected>30 ngày</option>
                            <option value="last_90d">90 ngày</option>
                            <option value="last_180d">180 ngày</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <button id="btn-refresh-meta-report" class="px-3 py-1 text-white rounded btn-primary text-sm">Cập nhật</button>
                    <button id="btn-export-meta-report" class="px-3 py-1 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;">Export CSV</button>
                </div>
            </div>
            
            <!-- Meta Report Summary Cards -->
            <div class="p-6 border-b border-gray-200">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="meta-report-metric bg-blue-50">
                        <div class="text-xs text-blue-600 font-medium">Tổng thương hiệu</div>
                        <div id="meta-total-brands" class="text-lg font-bold text-blue-800">0</div>
                    </div>
                    <div class="meta-report-metric bg-green-50">
                        <div class="text-xs text-green-600 font-medium">Định dạng nội dung</div>
                        <div id="meta-total-content-formats" class="text-lg font-bold text-green-800">0</div>
                    </div>
                    <div class="meta-report-metric bg-purple-50">
                        <div class="text-xs text-purple-600 font-medium">Tổng chi tiêu</div>
                        <div id="meta-total-spend" class="text-lg font-bold text-purple-800">$0</div>
                    </div>
                    <div class="meta-report-metric bg-orange-50">
                        <div class="text-xs text-orange-600 font-medium">Tổng Reach</div>
                        <div id="meta-total-reach" class="text-lg font-bold text-orange-800">0</div>
                    </div>
                    <div class="meta-report-metric bg-red-50">
                        <div class="text-xs text-red-600 font-medium">Tổng Engagement</div>
                        <div id="meta-total-engagement" class="text-lg font-bold text-red-800">0</div>
                    </div>
                    <div class="meta-report-metric bg-indigo-50">
                        <div class="text-xs text-indigo-600 font-medium">CTR Trung bình</div>
                        <div id="meta-avg-ctr" class="text-lg font-bold text-indigo-800">0%</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Performance Table -->
            <div class="overflow-x-auto meta-report-table">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">Tháng</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thương hiệu</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Định dạng nội dung</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chiến dịch</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi tiêu</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reach</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impressions</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clicks</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CTR</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPC</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engagement</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engagement Rate</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video Views</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Clicks</th>
                        </tr>
                    </thead>
                    <tbody id="meta-report-table" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="14" class="px-6 py-4 text-center text-gray-500">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Brand Analysis Section -->
            <div class="p-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold mb-4 text-gray-800">Phân tích theo Thương hiệu</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Top Thương hiệu theo Chi tiêu</h5>
                        <div id="brand-analysis-list" class="space-y-2">
                            <!-- Brand analysis will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Biểu đồ Thương hiệu</h5>
                        <div class="h-64 meta-report-chart-container">
                            <canvas id="brand-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Format Analysis Section -->
            <div class="p-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold mb-4 text-gray-800">Phân tích theo Định dạng Nội dung</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Top Định dạng theo Performance Score</h5>
                        <div id="content-analysis-list" class="space-y-2">
                            <!-- Content analysis will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Biểu đồ Định dạng Nội dung</h5>
                        <div class="h-64 meta-report-chart-container">
                            <canvas id="content-format-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Trends Chart -->
            <div class="p-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold mb-4 text-gray-800">Xu hướng Hiệu suất theo Tháng</h4>
                <div class="h-80 meta-report-chart-container">
                    <canvas id="monthly-trends-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow mt-8 hidden border border-gray-100" id="insights-panel">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Insights Chiến dịch</h3>
                <button id="close-insights" class="text-sm text-gray-600 hover:text-gray-900">Đóng</button>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div>
                    <div class="text-sm text-gray-500">Impressions</div>
                    <div id="insights-imp" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Clicks</div>
                    <div id="insights-clicks" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Spend</div>
                    <div id="insights-spend" class="text-2xl font-semibold">$0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Reach</div>
                    <div id="insights-reach" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">CTR</div>
                    <div id="insights-ctr" class="text-2xl font-semibold">0%</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Tần suất</div>
                    <div id="insights-frequency" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Link Clicks</div>
                    <div id="insights-link-clicks" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Unique Link Clicks</div>
                    <div id="insights-unique-link-clicks" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Post Engagement</div>
                    <div id="insights-engagement" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Photo Views</div>
                    <div id="insights-photo-views" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Video Views</div>
                    <div id="insights-video-views" class="text-2xl font-semibold">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Lượt xem tổng</div>
                    <div id="insights-total-views" class="text-2xl font-semibold">0</div>
                </div>
            </div>
            <div class="p-6">
                <div style="height:320px"><canvas id="insightsChart"></canvas></div>
            </div>
            
            <!-- Funnel Chart Section -->
            <div class="px-6 pb-6">
                <h4 class="text-lg font-semibold mb-4 text-gray-800">Biểu đồ Phễu (Funnel Chart)</h4>
                <p class="text-sm text-gray-600 mb-4">Hiển thị quá trình chuyển đổi từ hiển thị đến chuyển đổi</p>
                <div class="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                    <div id="funnelChart" style="min-height:400px; position: relative;">
                        <!-- Funnel chart will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="px-6 pb-6">
                <div id="insights-note" class="hidden mb-3 text-sm bg-yellow-50 text-yellow-800 border border-yellow-200 rounded px-3 py-2"></div>
                
                <!-- AI Insights Section -->
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800">
                            AI Insights & Recommendations
                        </h4>
                        <button id="btn-ai-analysis" class="px-4 py-2 text-white rounded-lg btn-primary text-sm hover:shadow-md transition-shadow">
                            Phân tích AI
                        </button>
                    </div>
                    
                    <!-- AI Analysis Results -->
                    <div id="ai-analysis-content" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Insights Panel -->
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <h5 class="font-semibold text-gray-700 mb-3">
                                    Insights (AI Generated)
                                </h5>
                                <div id="ai-insights" class="text-sm text-gray-600 leading-relaxed">
                                    <!-- AI insights sẽ được hiển thị ở đây -->
                                </div>
                            </div>
                            
                            <!-- Recommendations Panel -->
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <h5 class="font-semibold text-gray-700 mb-3">
                                    Recommended Actions
                                </h5>
                                <div id="ai-recommendations" class="text-sm text-gray-600 leading-relaxed">
                                    <!-- AI recommendations sẽ được hiển thị ở đây -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Timestamp & Cache Info -->
                        <div class="mt-3 text-xs text-gray-500 text-center" id="ai-analysis-timestamp">
                            <!-- Timestamp sẽ được hiển thị ở đây -->
                        </div>
                        <div class="mt-1 text-xs text-blue-600 text-center hidden" id="ai-cache-indicator">
                            Kết quả từ cache (nhanh hơn)
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="ai-loading" class="hidden text-center py-8">
                        <div class="inline-flex items-center px-4 py-2 text-sm text-blue-600">
                            AI đang phân tích dữ liệu campaign...
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="ai-error" class="hidden text-center py-4">
                        <div class="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-3">
                            <div id="ai-error-message">Có lỗi xảy ra khi phân tích AI</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button id="btn-break-placement" class="px-3 py-1 text-sm text-white btn-primary rounded-l">Placement</button>
                        <button id="btn-break-age" class="px-3 py-1 text-sm border" style="border-color:#247ba0;color:#247ba0;">Age/Gender</button>
                        <button id="btn-break-country" class="px-3 py-1 text-sm border rounded-r" style="border-color:#247ba0;color:#247ba0;">Country</button>
                    </div>
                    <div class="ml-auto flex items-center gap-2 text-sm
                        <label>Khoảng ngày</label>
                        <select id="date-preset" class="border px-2 py-1 rounded">
                            <option value="last_7d">7 ngày</option>
                            <option value="last_30d" selected>30 ngày</option>
                            <option value="last_90d">90 ngày</option>
                            <option value="lifetime">Lifetime</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="date" id="since" class="border px-2 py-1 rounded hidden">
                        <span class="hidden" id="range-sep">→</span>
                        <input type="date" id="until" class="border px-2 py-1 rounded hidden">
                        <button id="apply-range" class="px-3 py-1 rounded border hidden" style="border-color:#247ba0;color:#247ba0;">Áp dụng</button>
                    </div>
                </div>
                <div style="height:280px"><canvas id="breakdownChart"></canvas></div>
                <div class="mt-6">
                    <h4 class="font-medium mb-2">Ads trong chiến dịch</h4>
                    <div id="creative-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </main>

    <button id="chatbot-toggle" class="chatbot-toggle text-white rounded-full p-4 shadow-lg btn-primary">
        Chat
    </button>

    <div id="chatbot-container" class="chatbot-container bg-white rounded-lg shadow-lg w-80">
        <div class="text-white px-4 py-3 rounded-t-lg btn-primary">
            <h3 class="font-medium">Facebook Ads Assistant</h3>
            <p class="text-sm opacity-90">Hỏi tôi về dữ liệu quảng cáo</p>
        </div>
        <div class="p-4">
            <div id="chatbot-messages" class="chatbot-messages mb-4">
                <div class="message bot-message">Xin chào! Hãy hỏi tôi bất kỳ câu hỏi nào.</div>
            </div>
            <div class="flex space-x-2">
                <input type="text" id="chatbot-input" placeholder="Nhập câu hỏi..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
                <button id="chatbot-send" class="px-4 py-2 text-white rounded-md btn-primary">Gửi</button>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
                <button class="px-3 py-2 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;" data-suggest="Tóm tắt hiệu suất 7 ngày qua của campaign đang xem">Tóm tắt 7 ngày</button>
                <button class="px-3 py-2 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;" data-suggest="Tìm ngày có chi tiêu bất thường và giải thích">Tìm outlier</button>
                <button class="px-3 py-2 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;" data-suggest="Đề xuất 3 hành động để giảm CPM 15% dựa trên dữ liệu">Gợi ý tối ưu</button>
                <button class="px-3 py-2 text-sm rounded border" style="border-color:#247ba0;color:#247ba0;" data-suggest="Top 3 placement hiệu quả nhất theo impressions và CPC">Top placement</button>
            </div>
        </div>
    </div>
    <script>
        let adsData = null;
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadAdsData();
            initializeChatbot();
            initializeDailyTracking();
            initializeMetaReportInsights();
        });

        async function loadAdsData() {
            try {
                const response = await fetch('/api/ads-data');
                adsData = await response.json();
                if (adsData.error) return;
                updateDashboard(adsData);
            } catch (e) { console.error(e); }
        }

        function updateDashboard(data) {
            const lastUpdate = document.getElementById('last-update');
            if (data.extraction_date) {
                const d = new Date(data.extraction_date);
                lastUpdate.textContent = d.toLocaleString('vi-VN');
            }
            const total = data.campaigns.length;
            const active = data.campaigns.filter(c => c.status === 'ACTIVE').length;
            const paused = total - active;
            document.getElementById('total-campaigns').textContent = total.toLocaleString();
            document.getElementById('active-campaigns').textContent = active.toLocaleString();
            document.getElementById('paused-campaigns').textContent = paused.toLocaleString();
            updateCampaignsTable(data.campaigns);
            createCharts(data.campaigns);
        }

        // Manual refresh
        document.addEventListener('DOMContentLoaded',()=>{
            const btn=document.getElementById('btn-refresh');
            if(btn){
                btn.addEventListener('click',async ()=>{
                    btn.disabled=true; btn.textContent='Đang cập nhật...';
                    try{
                        const res=await fetch('/api/refresh',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({start_date:'2023-01-01'})});
                        const j=await res.json();
                        if(!j.ok){ alert('Không cập nhật được dữ liệu: '+(j.error||'unknown')); }
                        await loadAdsData();
                    }catch(e){ alert('Lỗi kết nối khi cập nhật'); }
                    finally{ btn.disabled=false; btn.textContent='Cập nhật dữ liệu'; }
                });
            }
        });

        function computeKetQua(c){
            // Kết quả theo mục tiêu: ưu tiên link clicks, engagement, video views
            const ins=c.insights||{};
            const obj=(c.objective||'').toUpperCase();
            if(obj.includes('TRAFFIC')){
                return `${(ins.inline_link_clicks||ins.clicks||0)} Link clicks`;
            }
            if(obj.includes('ENGAGEMENT')){
                const pe=ins.post_engagement||0; return `${pe} Engagement`;
            }
            if(obj.includes('VIDEO')){
                const vv=ins.video_views||ins.video_play_actions||0; return `${vv} Video views`;
            }
            return `${ins.clicks||0} Clicks`;
        }
        function updateCampaignsTable(campaigns) {
            const tbody = document.getElementById('campaigns-table');
            tbody.innerHTML = '';
            campaigns.forEach(c => {
                const tr = document.createElement('tr');
                const fmt = (s)=>{ if(!s) return '-'; const d=new Date(s); return isNaN(d)? s : d.toLocaleDateString('vi-VN'); };
                const titleCase = (s)=> (s||'').toLowerCase().replace(/_/g,' ').replace(/\b\w/g, m=>m.toUpperCase());
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.campaign_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${c.status === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${c.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${titleCase(c.objective)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fmt(c.created_time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fmt(c.start_time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fmt(c.stop_time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><button class="px-3 py-1 text-white rounded btn-primary" onclick="viewInsights('${c.campaign_id}', '${c.status}')">Xem</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function createCharts(campaigns) {
            const truncate = (s, n=20) => (s||'').length>n ? (s.slice(0,n-1)+'…') : (s||'Unknown');
            const objCounts = {};
            const statusCounts = {};
            campaigns.forEach(c=>{ objCounts[c.objective]=(objCounts[c.objective]||0)+1; statusCounts[c.status]=(statusCounts[c.status]||0)+1; });
            const objEntries = Object.entries(objCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
            const objLabels = objEntries.map(([k])=>truncate(k));
            const objValues = objEntries.map(([,v])=>v);
            const statusLabels = Object.keys(statusCounts);
            const statusValues = Object.values(statusCounts);
            const objCtx = document.getElementById('objectiveChart').getContext('2d');
            charts.objective && charts.objective.destroy();
            charts.objective = new Chart(objCtx,{type:'bar',data:{labels:objLabels,datasets:[{label:'Số chiến dịch',data:objValues,backgroundColor:'#247ba0'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{autoSkip:true,maxRotation:0}},y:{beginAtZero:true,precision:0}}}});
            const stCtx = document.getElementById('statusChart').getContext('2d');
            charts.status && charts.status.destroy();
            charts.status = new Chart(stCtx,{type:'doughnut',data:{labels:statusLabels,datasets:[{data:statusValues,backgroundColor:['#10b981','#f59e0b','#6b7280','#ef4444','#3b82f6']} ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
        }

        async function viewInsights(campaignId, status) {
            try {
                // Align insights with current date range selection
                const preset = document.getElementById('date-preset')?.value || 'last_30d';
                let q = `date_preset=${encodeURIComponent(preset)}`;
                if (preset === 'custom') {
                    const s = document.getElementById('since').value;
                    const u = document.getElementById('until').value;
                    if (s && u) q = `since=${encodeURIComponent(s)}&until=${encodeURIComponent(u)}`;
                }
                const res = await fetch(`/api/campaign-insights?campaign_id=${encodeURIComponent(campaignId)}&status=${encodeURIComponent(status||'')}&${q}`);
                const data = await res.json();
                if (data.error) {
                    console.warn('Insights error', data.error);
                    const note = document.getElementById('insights-note');
                    if (note) {
                        let errorMessage = data.error;
                        if (typeof data.error === 'object' && data.error.message) {
                            errorMessage = data.error.message;
                        }
                        
                        // Check for token expiration
                        if (errorMessage.includes('expired') || errorMessage.includes('Session has expired')) {
                            errorMessage = 'Token Facebook đã hết hạn. Vui lòng cập nhật token mới trong file .env';
                        } else if (errorMessage.includes('190')) {
                            errorMessage = 'Token Facebook không hợp lệ hoặc đã hết hạn. Vui lòng cập nhật token mới.';
                        }
                        
                        note.textContent = errorMessage;
                        note.classList.remove('hidden');
                    }
                    return;
                }
                const panel = document.getElementById('insights-panel');
                panel.classList.remove('hidden'); panel.style.display='block';
                const vndFmt = new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0});
                document.getElementById('insights-imp').textContent = (data.totals.impressions||0).toLocaleString('vi-VN');
                document.getElementById('insights-clicks').textContent = (data.totals.clicks||0).toLocaleString('vi-VN');
                document.getElementById('insights-spend').textContent = vndFmt.format(parseFloat(data.totals.spend||0));
                const rows = Array.isArray(data.daily)?data.daily:[];
                const labels = rows.map(d=>d.date_start||d.date||d.date_stop||'').slice(-30);
                const imp = rows.map(d=>parseInt(d.impressions||0)).slice(-30);
                const spend = rows.map(d=>parseFloat(d.spend||0)).slice(-30);
                const ctx = document.getElementById('insightsChart').getContext('2d');
                charts.insights && charts.insights.destroy();
                charts.insights = new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Impressions',data:imp,borderColor:'#247ba0',backgroundColor:'rgba(36,123,160,0.15)',tension:.3,fill:true},{label:'Spend',data:spend,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',tension:.3,yAxisID:'y1'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true},y1:{position:'right',beginAtZero:true}}}});
                console.log('INSIGHTS', {labels, rows});
                // Hiển thị thêm các số liệu tổng hợp
                document.getElementById('insights-reach').textContent = (data.totals.reach||0).toLocaleString('vi-VN');
                document.getElementById('insights-ctr').textContent = ((data.totals.ctr||0).toFixed(2))+'%';
                document.getElementById('insights-frequency').textContent = (data.totals.frequency||0).toFixed(2);
                document.getElementById('insights-link-clicks').textContent = (data.totals.inline_link_clicks||0).toLocaleString('vi-VN');
                document.getElementById('insights-unique-link-clicks').textContent = (data.totals.unique_inline_link_clicks||0).toLocaleString('vi-VN');
                document.getElementById('insights-engagement').textContent = (data.totals.post_engagement||0).toLocaleString('vi-VN');
                document.getElementById('insights-photo-views').textContent = (data.totals.photo_view||0).toLocaleString('vi-VN');
                document.getElementById('insights-video-views').textContent = (data.totals.video_views||0).toLocaleString('vi-VN');
                const totalViews = (data.totals.impressions||0) + (data.totals.video_views||0);
                document.getElementById('insights-total-views').textContent = totalViews.toLocaleString('vi-VN');

                // Render funnel chart
                renderFunnelChart(data.totals);

                // Show fallback note if any
                const note = document.getElementById('insights-note');
                if (note) {
                    if (data.note) { note.textContent = data.note; note.classList.remove('hidden'); }
                    else { note.textContent=''; note.classList.add('hidden'); }
                }

                panel.scrollIntoView({behavior:'smooth',block:'start'});
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded',()=>{
            const closeBtn=document.getElementById('close-insights');
            if(closeBtn){ closeBtn.addEventListener('click',()=>{ document.getElementById('insights-panel').classList.add('hidden'); }); }
        });

        function initializeChatbot(){
            const toggleBtn=document.getElementById('chatbot-toggle');
            const container=document.getElementById('chatbot-container');
            const input=document.getElementById('chatbot-input');
            const sendBtn=document.getElementById('chatbot-send');
            toggleBtn.addEventListener('click',()=>{ container.style.display=container.style.display==='none'?'block':'none'; });
            function buildContext(){
                // Lấy dữ liệu đang có trong trang làm context cho bot
                const ctx={
                    campaigns_count: adsData?.campaigns?.length||0,
                    // Thêm dữ liệu daily gần nhất của biểu đồ nếu có
                };
                return ctx;
            }
            function sendMessage(q){ if(!q){ q=input.value.trim(); } if(!q) return; addMessage(q,'user'); input.value=''; addMessage('Đang xử lý...','bot'); fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,context:buildContext()})}).then(r=>r.json()).then(d=>{ removeLastMessage(); addMessage(d.error?('Lỗi: '+d.error):d.answer,'bot');}).catch(()=>{ removeLastMessage(); addMessage('Lỗi kết nối.','bot');}); }
            sendBtn.addEventListener('click',sendMessage); input.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage(); });
            // Nút gợi ý nhanh
            document.querySelectorAll('[data-suggest]').forEach(btn=>{ btn.addEventListener('click',()=> sendMessage(btn.getAttribute('data-suggest'))); });
        }
        function addMessage(text,type){ const box=document.getElementById('chatbot-messages'); const div=document.createElement('div'); div.className=`message ${type}-message`; div.textContent=text; box.appendChild(div); box.scrollTop=box.scrollHeight; }
        function removeLastMessage(){ const box=document.getElementById('chatbot-messages'); const msgs=box.querySelectorAll('.message'); if(msgs.length>0) msgs[msgs.length-1].remove(); }
        async function fetchBreakdown(campaignId, kind){
            const preset=document.getElementById('date-preset')?.value||'last_30d';
            let q=`date_preset=${encodeURIComponent(preset)}`;
            if(preset==='custom'){
                const s=document.getElementById('since').value; const u=document.getElementById('until').value;
                if(s&&u) q=`since=${encodeURIComponent(s)}&until=${encodeURIComponent(u)}`;
            }
            const url=`/api/campaign-breakdown?campaign_id=${encodeURIComponent(campaignId)}&kind=${kind}&${q}`;
            const res = await fetch(url);
            const data = await res.json();
            console.log('BREAKDOWN', kind, url, data);
            return data;
        }
        async function fetchAds(campaignId){
            const preset=document.getElementById('date-preset')?.value||'last_30d';
            let q=`date_preset=${encodeURIComponent(preset)}`;
            if(preset==='custom'){
                const s=document.getElementById('since').value; const u=document.getElementById('until').value;
                if(s&&u) q=`since=${encodeURIComponent(s)}&until=${encodeURIComponent(u)}`;
            }
            const url=`/api/campaign-ads?campaign_id=${encodeURIComponent(campaignId)}&${q}`;
            const res = await fetch(url);
            const data = await res.json();
            console.log('ADS', url, data);
            return data;
        }
        function toCSV(rows){ if(!rows||!rows.length) return ''; const keys=Object.keys(rows[0]); const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`; return [keys.join(','),...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n'); }
        const VND_FMT = new Intl.NumberFormat('vi-VN',{ style:'currency', currency:'VND', maximumFractionDigits:0 });
        const NUM_FMT = new Intl.NumberFormat('vi-VN');
        function mapPlacementLabel(p){
            const m={
                'facebook:feed':'Facebook News Feed',
                'facebook:facebook_profile_feed':'Feed Profile',
                'facebook:video_feeds':'Video Feed',
                'facebook:story':'Stories',
                'instagram:stream':'Feed',
                'instagram:story':'Stories',
                'instagram:reels':'Reels',
                'audience_network:classic':'Audience Network',
                'messenger:inbox':'Inbox',
                'messenger:story':'Stories'
            };
            if(!p) return 'Unknown';
            const key=p.toLowerCase();
            if(m[key]) return m[key];
            // try format like publisher:position
            const parts=key.split(':');
            if(parts.length===2){
                const prettyPub=parts[0]==='facebook'?'':parts[0]==='instagram'?'':parts[0]==='messenger'?'':parts[0]==='audience_network'?'Audience Network':parts[0];
                const pos=parts[1].replace(/_/g,' ');
                return `${prettyPub} ${pos.charAt(0).toUpperCase()+pos.slice(1)}`;
            }
            return p;
        }
        function renderBreakdown(kind, rows){
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            charts.breakdown && charts.breakdown.destroy();
            let labels=[], values=[];
            const keyMap={placement:'placement',age_gender:r=>`${r.age||''}/${r.gender||''}`,country:'country'};
            rows.forEach(r=>{ const labelRaw = typeof keyMap[kind]==='function'?keyMap[kind](r):(r[keyMap[kind]]||'Unknown'); const label = (kind==='placement')?mapPlacementLabel(labelRaw):labelRaw; labels.push(label); values.push(parseInt(r.impressions||0)); })
            charts.breakdown = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Impressions',data:values,backgroundColor:'#247ba0'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
        }
        function renderCreatives(items){
            const box=document.getElementById('creative-list');
            box.innerHTML='';
            if(!items || !items.length){ box.innerHTML='<div class="text-sm text-gray-500">Không có dữ liệu ads.</div>'; return; }
            const table=document.createElement('table');
            table.className='min-w-full divide-y divide-gray-200 text-sm';
            table.innerHTML=`<thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Ad</th><th class="px-3 py-2 text-left">Status</th><th class="px-3 py-2 text-left">Impr</th><th class="px-3 py-2 text-left">Clicks</th><th class="px-3 py-2 text-left">Chi phí</th></tr></thead><tbody></tbody>`;
            const tb=table.querySelector('tbody');
            items.forEach(it=>{
                const ins=it.insights||{};
                const tr=document.createElement('tr');
                tr.innerHTML=`<td class="px-3 py-2">${it.ad.name||it.ad.id}</td><td class="px-3 py-2">${it.ad.status||''}</td><td class="px-3 py-2">${NUM_FMT.format(parseInt(ins.impressions||0))}</td><td class="px-3 py-2">${NUM_FMT.format(parseInt(ins.clicks||0))}</td><td class="px-3 py-2">${VND_FMT.format(parseFloat(ins.spend||0))}</td>`;
                tb.appendChild(tr);
            })
            box.appendChild(table);
        }
        
        // Funnel Chart Function - 3D Style
        function renderFunnelChart(totals) {
            // Clear any existing chart
            charts.funnel && charts.funnel.destroy();
            
            // Calculate funnel metrics
            const impressions = parseInt(totals.impressions || 0);
            const clicks = parseInt(totals.clicks || 0);
            const linkClicks = parseInt(totals.inline_link_clicks || 0);
            const engagement = parseInt(totals.post_engagement || 0);
            const reach = parseInt(totals.reach || 0);
            const msgStarts = parseInt(totals.messaging_starts || 0);
            const purchases = parseInt(totals.purchases || 0);
            const spend = parseFloat(totals.spend || 0);
            
            // Calculate cost metrics
            const cpm = impressions > 0 ? (spend / impressions) * 1000 : 0;
            const cpc = clicks > 0 ? spend / clicks : 0;
            const cpe = engagement > 0 ? spend / engagement : 0;
            const cpl = linkClicks > 0 ? spend / linkClicks : 0;
            const cpmsg = msgStarts > 0 ? spend / msgStarts : 0;
            const cpa = purchases > 0 ? spend / purchases : 0;
            
            // Define funnel stages with 3D colors
            const maxMetric = Math.max(impressions, reach, engagement, Math.max(linkClicks, clicks, msgStarts), Math.max(purchases, 1));

            const funnelData = [
                {
                    stageKey: 'display',
                    color: '#0f3b66',
                    lightColor: 'rgba(15, 59, 102, 0.85)',
                    widthValue: impressions,
                    header: 'Impressions',
                    lines: [
                        { label: 'Impressions', value: impressions },
                        { label: 'Reach', value: reach }
                    ],
                    right: [
                        { label: 'CPM', value: cpm, decimals: 1, hint: 'Hiển thị' }
                    ]
                },
                {
                    stageKey: 'engagement',
                    color: '#07869b',
                    lightColor: 'rgba(7, 134, 155, 0.85)',
                    widthValue: engagement,
                    header: 'Post Engagement',
                    lines: [
                        { label: 'Post Engagement', value: engagement }
                    ],
                    right: [
                        { label: 'Cost per Post Engagement', value: cpe, decimals: 2, hint: 'Tương tác' }
                    ]
                },
                {
                    stageKey: 'interest',
                    color: '#e6a500',
                    lightColor: 'rgba(230, 165, 0, 0.9)',
                    widthValue: Math.max(linkClicks, clicks, msgStarts),
                    header: 'Interest',
                    lines: [
                        { label: 'Link Clicks', value: linkClicks },
                        { label: 'Clicks', value: clicks },
                        { label: 'Messaging Starts', value: msgStarts }
                    ],
                    right: [
                        { label: 'CPC', value: cpc, decimals: 1, hint: 'Quan tâm' },
                        { label: 'Cost per Message', value: cpmsg, decimals: 1 }
                    ]
                },
                {
                    stageKey: 'conversion',
                    color: '#d94a4a',
                    lightColor: 'rgba(217, 74, 74, 0.9)',
                    widthValue: Math.max(purchases, 1),
                    header: 'Purchases',
                    lines: [
                        { label: 'Purchases', value: purchases }
                    ],
                    right: [
                        { label: 'CPA', value: cpa, decimals: 1, hint: 'Chuyển đổi' }
                    ]
                }
            ];
            
            // Create custom funnel chart using HTML/CSS
            const funnelContainer = document.getElementById('funnelChart');
            funnelContainer.innerHTML = `
                <div class="funnel-container" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px;">
                    <div class="funnel-header" style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px;">
                        <span style="font-weight: 600; color: #374151;">Đã chi tiêu</span>
                        <span style="font-weight: 600; color: #374151;">Total Cost ${VND_FMT.format(spend)}</span>
                    </div>
                    ${funnelData.map((stage, index) => {
                        const width = Math.max(25, (stage.widthValue / Math.max(maxMetric, 1)) * 100);
                        return `
                            <div class="funnel-stage" style="display: flex; align-items: center; width: 100%; margin-bottom: 12px;">
                                <div class="funnel-segment" style="
                                    width: ${width}%;
                                    height: 60px;
                                    background: linear-gradient(135deg, ${stage.color}, ${stage.lightColor});
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-weight: bold;
                                    text-align: center;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        right: 0;
                                        height: 30%;
                                        background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
                                    "></div>
                                    <div style="z-index: 1; line-height: 1.2;">
                                        <div style="font-size: 14px; margin-bottom: 2px;">${stage.header}</div>
                                        ${stage.lines.map(l=>`<div style=\"font-size:16px; font-weight:700;\">${l.label}: ${NUM_FMT.format(parseInt(l.value||0))}</div>`).join('')}
                                    </div>
                                </div>
                                <div class="cost-metrics" style="
                                    margin-left: 20px;
                                    text-align: left;
                                    min-width: 200px;
                                ">
                                    ${stage.right.map(r=>`
                                        <div style=\"display:flex; align-items:center; gap:10px; margin-bottom:4px;\">
                                            <div>
                                                <div style=\"font-size:12px; color:#6b7280;\">${r.label}</div>
                                                <div style=\"font-size:14px; font-weight:600; color:#374151;\">${(r.value||0).toFixed(r.decimals ?? 1)}</div>
                                            </div>
                                            ${r.hint?`<div style=\"font-size:12px; color:#374151; margin-left:10px; white-space:nowrap;\">${r.hint}</div>`:''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        // AI Analysis Functions
        async function performAIAnalysis(campaignId) {
            const aiContent = document.getElementById('ai-analysis-content');
            const aiLoading = document.getElementById('ai-loading');
            const aiError = document.getElementById('ai-error');
            const aiErrorMsg = document.getElementById('ai-error-message');
            
            // Show loading state
            aiContent.classList.add('hidden');
            aiError.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/campaign-ai-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaign_id: campaignId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results với error handling
                    try {
                        document.getElementById('ai-insights').innerHTML = formatAIResponse(data.insights);
                        document.getElementById('ai-recommendations').innerHTML = formatAIResponse(data.recommendations);
                    } catch (formatError) {
                        console.error('Error formatting AI response:', formatError);
                        console.log('Raw insights data:', data.insights);
                        console.log('Raw recommendations data:', data.recommendations);
                        
                        // Fallback display
                        document.getElementById('ai-insights').innerHTML = `<div class="text-sm text-gray-600">
                            <strong>Insights:</strong><br>
                            ${typeof data.insights === 'string' ? data.insights : JSON.stringify(data.insights, null, 2)}
                        </div>`;
                        document.getElementById('ai-recommendations').innerHTML = `<div class="text-sm text-gray-600">
                            <strong>Recommendations:</strong><br>
                            ${typeof data.recommendations === 'string' ? data.recommendations : JSON.stringify(data.recommendations, null, 2)}
                        </div>`;
                    }
                    
                    // Show timestamp
                    const timestamp = new Date(data.timestamp).toLocaleString('vi-VN');
                    document.getElementById('ai-analysis-timestamp').textContent = `Phân tích lúc: ${timestamp}`;
                    
                    // Show cache indicator if cached
                    const cacheIndicator = document.getElementById('ai-cache-indicator');
                    if (data.cached) {
                        cacheIndicator.classList.remove('hidden');
                    } else {
                        cacheIndicator.classList.add('hidden');
                    }
                    
                    // Show content
                    aiLoading.classList.add('hidden');
                    aiContent.classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Không thể phân tích AI');
                }
            } catch (error) {
                console.error('AI Analysis Error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                aiErrorMsg.textContent = error.message || 'Có lỗi xảy ra khi phân tích AI';
                aiLoading.classList.add('hidden');
                aiError.classList.remove('hidden');
            }
        }
        
        function formatAIResponse(text) {
            if (!text) return '<em>Không có dữ liệu</em>';
            
            // Đảm bảo text là string
            let textStr = '';
            if (typeof text === 'string') {
                textStr = text;
            } else if (typeof text === 'object') {
                // Nếu là object, convert thành string
                textStr = JSON.stringify(text, null, 2);
            } else {
                textStr = String(text);
            }
            
            // Convert line breaks to HTML and add bullet points
            return textStr
                .split('\n')
                .filter(line => line.trim())
                .map(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('-') || trimmed.startsWith('•') || trimmed.startsWith('*')) {
                        return `<div class="flex items-start mb-2">
                            <span class="text-blue-600 mr-2 mt-1">-</span>
                            <span>${trimmed.substring(1).trim()}</span>
                        </div>`;
                    }
                    return `<div class="mb-2">${trimmed}</div>`;
                })
                .join('');
        }
        
        function resetAIState() {
            document.getElementById('ai-analysis-content').classList.add('hidden');
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-error').classList.add('hidden');
            document.getElementById('ai-cache-indicator').classList.add('hidden');
        }

        // Daily Tracking Functions
        let dailyTrackingData = null;

        function initializeDailyTracking() {
            // Load initial data
            loadDailyTrackingData();
            
            // Event listeners
            document.getElementById('btn-refresh-daily').addEventListener('click', loadDailyTrackingData);
            document.getElementById('btn-export-daily').addEventListener('click', exportDailyData);
            document.getElementById('daily-date-preset').addEventListener('change', loadDailyTrackingData);
        }

        async function refreshBudgetCache() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Đang cập nhật...';
                button.disabled = true;
                
                const response = await fetch('/api/refresh-budgets');
                const data = await response.json();
                
                if (data.success) {
                    alert(`✅ Cập nhật thành công!\n- ${data.updated_count} campaigns được cập nhật\n- ${data.failed_count} campaigns thất bại\n\nCache sẽ được sử dụng trong 1 giờ tới.`);
                    // Reload daily tracking data to show updated budget info
                    loadDailyTrackingData();
                } else {
                    alert(`❌ Lỗi: ${data.error}`);
                }
            } catch (error) {
                console.error('Error refreshing budget cache:', error);
                alert('❌ Lỗi kết nối khi cập nhật ngân sách');
            } finally {
                button.textContent = 'Cập nhật Ngân sách';
                button.disabled = false;
            }
        }

        async function loadDailyTrackingData() {
            try {
                const preset = document.getElementById('daily-date-preset').value;
                const tbody = document.getElementById('daily-tracking-table');
                tbody.innerHTML = '<tr><td colspan="24" class="px-6 py-4 text-center text-gray-500">Đang tải dữ liệu...</td></tr>';
                
                const response = await fetch(`/api/daily-tracking?date_preset=${encodeURIComponent(preset)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Daily tracking error:', data.error);
                    let errorMessage = data.error;
                    if (typeof data.error === 'object' && data.error.message) {
                        errorMessage = data.error.message;
                    }
                    
                    // Check for token expiration
                    if (errorMessage.includes('expired') || errorMessage.includes('Session has expired')) {
                        errorMessage = 'Token Facebook đã hết hạn. Vui lòng cập nhật token mới trong file .env';
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="24" class="px-6 py-4 text-center text-red-500">Lỗi: ${errorMessage}</td></tr>`;
                    return;
                }
                
                dailyTrackingData = data;
                updateDailyTrackingTable(data);
                updateDailySummaryCards(data);
                if (typeof updatePivotAdvanced === 'function') {
                    updatePivotAdvanced(data);
                }
                
                // Show campaign status
                const statusEl = document.getElementById('campaign-status');
                if (data.total_campaigns > 0) {
                    let statusText = `Đã tải ${data.successful_campaigns}/${data.processed_campaigns || data.total_campaigns} chiến dịch`;
                    if (data.note) {
                        statusText += ` (${data.note})`;
                    }
                    statusEl.textContent = statusText;
                    statusEl.classList.remove('hidden');
                    if (data.failed_campaigns > 0) {
                        statusEl.classList.add('text-yellow-600');
                        statusEl.classList.remove('text-blue-600');
                    } else {
                        statusEl.classList.add('text-green-600');
                        statusEl.classList.remove('text-blue-600');
                    }
                } else {
                    statusEl.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading daily tracking data:', error);
                const tbody = document.getElementById('daily-tracking-table');
                let errorMessage = 'Lỗi kết nối khi tải dữ liệu';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'Lỗi timeout - Dữ liệu quá lớn, vui lòng thử lại với date range nhỏ hơn';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Lỗi timeout - Vui lòng thử lại';
                }
                
                tbody.innerHTML = `<tr><td colspan="24" class="px-6 py-4 text-center text-red-500">${errorMessage}</td></tr>`;
            }
        }

        function updateDailyTrackingTable(data) {
            const tbody = document.getElementById('daily-tracking-table');
            tbody.innerHTML = '';
            
            if (!data.daily || data.daily.length === 0) {
                tbody.innerHTML = '<tr><td colspan="24" class="px-6 py-4 text-center text-gray-500">Không có dữ liệu</td></tr>';
                return;
            }
            
            data.daily.forEach(day => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Calculate metrics
                const spend = parseFloat(day.spend || 0);
                const reach = parseInt(day.reach || 0);
                const impressions = parseInt(day.impressions || 0);
                const clicks = parseInt(day.clicks || 0);
                const linkClicks = parseInt(day.inline_link_clicks || 0);
                const engagement = parseInt(day.post_engagement || 0);
                const messagingStarts = parseInt(day.messaging_contacts || day.messaging_starts || 0);
                const messagingNew = parseInt(day.messaging_new_contacts || 0);
                const purchases = parseInt(day.purchases || 0);
                const purchaseValue = parseFloat(day.purchase_value || 0);
                const frequency = parseFloat(day.frequency || 0);
                const videoViews = parseInt(day.video_views || 0);
                
                // Calculate derived metrics
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const linkCtr = impressions > 0 ? (linkClicks / impressions) * 100 : 0;
                const cpc = clicks > 0 ? spend / clicks : 0;
                const linkCpc = linkClicks > 0 ? spend / linkClicks : 0;
                const cpm = impressions > 0 ? (spend / impressions) * 1000 : 0;
                const cpe = engagement > 0 ? spend / engagement : 0;
                const roas = spend > 0 ? purchaseValue / spend : 0;
                
                // Determine result based on objective (simplified)
                const result = linkClicks > 0 ? `${linkClicks} Link Clicks` : 
                              engagement > 0 ? `${engagement} Engagement` : 
                              `${clicks} Clicks`;
                
                const photoViews = parseInt(day.photo_view || 0);
                const video2sPlus = parseInt(day.video_2_sec_watched_actions || 0);
                const campaignCount = parseInt(day.campaign_count || 0);
                
                // Budget calculations
                const dailyBudget = parseFloat(day.daily_budget || 0);
                const lifetimeBudget = parseFloat(day.lifetime_budget || 0);
                const budgetRemaining = parseFloat(day.budget_remaining || 0);
                const totalBudget = dailyBudget + lifetimeBudget;
                const budgetUtilization = totalBudget > 0 ? (spend / totalBudget) * 100 : 0;
                
                row.innerHTML = `
                    <td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">
                        ${new Date(day.date_start || day.date).toLocaleDateString('vi-VN')}
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-500">-</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${VND_FMT.format(spend)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${totalBudget > 0 ? VND_FMT.format(totalBudget) : (budgetRemaining > 0 ? `Remaining: ${VND_FMT.format(budgetRemaining)}` : '-')}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(reach)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(impressions)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${frequency.toFixed(2)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${result}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(cpc)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(messagingStarts)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(messagingNew)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${roas.toFixed(2)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${ctr.toFixed(2)}%</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(cpm)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(engagement)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(linkClicks)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${linkCtr.toFixed(2)}%</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(linkCpc)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(videoViews)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(photoViews)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(cpe)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(video2sPlus)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(purchaseValue)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${campaignCount}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateDailySummaryCards(data) {
            if (!data.totals) return;
            
            const totals = data.totals;
            const spend = parseFloat(totals.spend || 0);
            const reach = parseInt(totals.reach || 0);
            const impressions = parseInt(totals.impressions || 0);
            const clicks = parseInt(totals.clicks || 0);
            const linkClicks = parseInt(totals.inline_link_clicks || 0);
            const engagement = parseInt(totals.post_engagement || 0);
            const messagingStarts = parseInt(totals.messaging_contacts || totals.messaging_starts || 0);
            const messagingNew = parseInt(totals.messaging_new_contacts || 0);
            const purchases = parseInt(totals.purchases || 0);
            const purchaseValue = parseFloat(totals.purchase_value || 0);
            
            // Calculate averages
            const avgCtr = impressions > 0 ? (clicks / impressions) * 100 : 0;
            const avgCpc = clicks > 0 ? spend / clicks : 0;
            const avgCpm = impressions > 0 ? (spend / impressions) * 1000 : 0;
            const avgRoas = spend > 0 ? purchaseValue / spend : 0;
            
            // Update summary cards
            document.getElementById('daily-total-spend').textContent = VND_FMT.format(spend);
            document.getElementById('daily-total-reach').textContent = NUM_FMT.format(reach);
            document.getElementById('daily-total-impressions').textContent = NUM_FMT.format(impressions);
            document.getElementById('daily-avg-ctr').textContent = avgCtr.toFixed(2) + '%';
            document.getElementById('daily-avg-cpc').textContent = VND_FMT.format(avgCpc);
            document.getElementById('daily-avg-cpm').textContent = VND_FMT.format(avgCpm);
            
            // Update summary section
            document.getElementById('summary-total-spend').textContent = VND_FMT.format(spend);
            document.getElementById('summary-total-reach').textContent = NUM_FMT.format(reach);
            document.getElementById('summary-total-impressions').textContent = NUM_FMT.format(impressions);
            document.getElementById('summary-avg-ctr').textContent = avgCtr.toFixed(2) + '%';
            document.getElementById('summary-avg-cpc').textContent = VND_FMT.format(avgCpc);
            document.getElementById('summary-avg-cpm').textContent = VND_FMT.format(avgCpm);
            document.getElementById('summary-total-messaging').textContent = NUM_FMT.format(messagingStarts);
            document.getElementById('summary-total-conversions').textContent = NUM_FMT.format(messagingNew);
            document.getElementById('summary-avg-roas').textContent = avgRoas.toFixed(2);
        }

        function exportDailyData() {
            if (!dailyTrackingData || !dailyTrackingData.daily) {
                alert('Không có dữ liệu để export');
                return;
            }
            
            const rows = dailyTrackingData.daily.map(day => {
                const spend = parseFloat(day.spend || 0);
                const reach = parseInt(day.reach || 0);
                const impressions = parseInt(day.impressions || 0);
                const clicks = parseInt(day.clicks || 0);
                const linkClicks = parseInt(day.inline_link_clicks || 0);
                const engagement = parseInt(day.post_engagement || 0);
                const messagingStarts = parseInt(day.messaging_contacts || day.messaging_starts || 0);
                const messagingNew = parseInt(day.messaging_new_contacts || 0);
                const purchases = parseInt(day.purchases || 0);
                const purchaseValue = parseFloat(day.purchase_value || 0);
                const frequency = parseFloat(day.frequency || 0);
                const videoViews = parseInt(day.video_views || 0);
                const photoViews = parseInt(day.photo_view || 0);
                const video2sPlus = parseInt(day.video_2_sec_watched_actions || 0);
                const campaignCount = parseInt(day.campaign_count || 0);
                
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const linkCtr = impressions > 0 ? (linkClicks / impressions) * 100 : 0;
                const cpc = clicks > 0 ? spend / clicks : 0;
                const linkCpc = linkClicks > 0 ? spend / linkClicks : 0;
                const cpm = impressions > 0 ? (spend / impressions) * 1000 : 0;
                const cpe = engagement > 0 ? spend / engagement : 0;
                const roas = spend > 0 ? purchaseValue / spend : 0;
                
                return {
                    'Ngày': new Date(day.date_start || day.date).toLocaleDateString('vi-VN'),
                    'Phân phối': '-',
                    'Tổng chi tiêu': spend,
                    'Ngân sách': '-',
                    'Reach': reach,
                    'Impressions': impressions,
                    'Tần suất': frequency,
                    'Kết quả': linkClicks > 0 ? `${linkClicks} Link Clicks` : engagement > 0 ? `${engagement} Engagement` : `${clicks} Clicks`,
                    'CPC': cpc,
                    'Người liên hệ nhắn tin': messagingStarts,
                    'Người liên hệ nhắn tin mới': messagingNew,
                    'ROAS': roas,
                    'CTR': ctr,
                    'CPM': cpm,
                    'Engagement': engagement,
                    'Link Clicks': linkClicks,
                    'Link CTR': linkCtr,
                    'Link CPC': linkCpc,
                    'Video Views': videoViews,
                    'Photo Views': photoViews,
                    'CPE': cpe,
                    'Video 2s+': video2sPlus,
                    'Purchase Value': purchaseValue,
                    'Campaigns': campaignCount
                };
            });
            
            const csv = toCSV(rows);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-tracking-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Meta Report Insights Functions
        let metaReportData = null;

        function initializeMetaReportInsights() {
            // Load initial data
            loadMetaReportData();
            
            // Event listeners
            document.getElementById('btn-refresh-meta-report').addEventListener('click', loadMetaReportData);
            document.getElementById('btn-export-meta-report').addEventListener('click', exportMetaReportData);
            document.getElementById('meta-report-date-preset').addEventListener('change', loadMetaReportData);
        }

        async function loadMetaReportData() {
            try {
                const preset = document.getElementById('meta-report-date-preset').value;
                const tbody = document.getElementById('meta-report-table');
                tbody.innerHTML = '<tr><td colspan="14" class="px-6 py-4 text-center text-gray-500">Đang tải dữ liệu...</td></tr>';
                
                const response = await fetch(`/api/meta-report-insights?date_preset=${encodeURIComponent(preset)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Meta Report Insights error:', data.error);
                    let errorMessage = data.error;
                    if (typeof data.error === 'object' && data.error.message) {
                        errorMessage = data.error.message;
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="14" class="px-6 py-4 text-center text-red-500">Lỗi: ${errorMessage}</td></tr>`;
                    return;
                }
                
                metaReportData = data;
                updateMetaReportTable(data);
                updateMetaReportSummaryCards(data);
                updateBrandAnalysis(data);
                updateContentAnalysis(data);
                createMetaReportCharts(data);
                
            } catch (error) {
                console.error('Error loading meta report data:', error);
                const tbody = document.getElementById('meta-report-table');
                tbody.innerHTML = '<tr><td colspan="14" class="px-6 py-4 text-center text-red-500">Lỗi kết nối khi tải dữ liệu</td></tr>';
            }
        }

        function updateMetaReportTable(data) {
            const tbody = document.getElementById('meta-report-table');
            tbody.innerHTML = '';
            
            if (!data.monthly_data || data.monthly_data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="px-6 py-4 text-center text-gray-500">Không có dữ liệu</td></tr>';
                return;
            }
            
            data.monthly_data.forEach(month => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Calculate metrics
                const spend = parseFloat(month.spend || 0);
                const reach = parseInt(month.reach || 0);
                const impressions = parseInt(month.impressions || 0);
                const clicks = parseInt(month.clicks || 0);
                const engagement = parseInt(month.engagement || 0);
                const videoViews = parseInt(month.video_views || 0);
                const linkClicks = parseInt(month.link_clicks || 0);
                
                // Calculate derived metrics
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const cpc = clicks > 0 ? spend / clicks : 0;
                const engagementRate = impressions > 0 ? (engagement / impressions) * 100 : 0;
                
                // Format brands and content formats
                const brandsText = month.brands ? month.brands.join(', ') : 'Unknown';
                const contentFormatsText = month.content_formats ? month.content_formats.join(', ') : 'Unknown';
                
                row.innerHTML = `
                    <td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">
                        ${month.month}
                    </td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-500">${brandsText}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-500">${contentFormatsText}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${month.campaign_count}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${VND_FMT.format(spend)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(reach)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(impressions)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(clicks)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${ctr.toFixed(2)}%</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${VND_FMT.format(cpc)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(engagement)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${engagementRate.toFixed(2)}%</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(videoViews)}</td>
                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-900">${NUM_FMT.format(linkClicks)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateMetaReportSummaryCards(data) {
            if (!data.monthly_data || data.monthly_data.length === 0) return;
            
            // Calculate totals
            let totalBrands = 0;
            let totalContentFormats = 0;
            let totalSpend = 0;
            let totalReach = 0;
            let totalEngagement = 0;
            let totalClicks = 0;
            let totalImpressions = 0;
            
            const allBrands = new Set();
            const allContentFormats = new Set();
            
            data.monthly_data.forEach(month => {
                totalSpend += parseFloat(month.spend || 0);
                totalReach += parseInt(month.reach || 0);
                totalEngagement += parseInt(month.engagement || 0);
                totalClicks += parseInt(month.clicks || 0);
                totalImpressions += parseInt(month.impressions || 0);
                
                if (month.brands) {
                    month.brands.forEach(brand => allBrands.add(brand));
                }
                if (month.content_formats) {
                    month.content_formats.forEach(format => allContentFormats.add(format));
                }
            });
            
            totalBrands = allBrands.size;
            totalContentFormats = allContentFormats.size;
            
            const avgCtr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;
            
            // Update summary cards
            document.getElementById('meta-total-brands').textContent = totalBrands;
            document.getElementById('meta-total-content-formats').textContent = totalContentFormats;
            document.getElementById('meta-total-spend').textContent = VND_FMT.format(totalSpend);
            document.getElementById('meta-total-reach').textContent = NUM_FMT.format(totalReach);
            document.getElementById('meta-total-engagement').textContent = NUM_FMT.format(totalEngagement);
            document.getElementById('meta-avg-ctr').textContent = avgCtr.toFixed(2) + '%';
        }

        function updateBrandAnalysis(data) {
            const brandList = document.getElementById('brand-analysis-list');
            brandList.innerHTML = '';
            
            if (!data.brand_analysis) return;
            
            Object.entries(data.brand_analysis).forEach(([brand, analysis]) => {
                const div = document.createElement('div');
                div.className = 'meta-report-analysis-item';
                
                const spend = parseFloat(analysis.total_spend || 0);
                const impressions = parseInt(analysis.total_impressions || 0);
                const clicks = parseInt(analysis.total_clicks || 0);
                const engagement = parseInt(analysis.total_engagement || 0);
                
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const engagementRate = impressions > 0 ? (engagement / impressions) * 100 : 0;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900">${brand}</div>
                            <div class="text-xs text-gray-500">${analysis.campaign_count} campaigns</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">${VND_FMT.format(spend)}</div>
                            <div class="text-xs text-gray-500">CTR: ${ctr.toFixed(2)}%</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        Reach: ${NUM_FMT.format(impressions)} | Engagement: ${NUM_FMT.format(engagement)} (${engagementRate.toFixed(2)}%)
                    </div>
                `;
                
                brandList.appendChild(div);
            });
        }

        function updateContentAnalysis(data) {
            const contentList = document.getElementById('content-analysis-list');
            contentList.innerHTML = '';
            
            if (!data.content_analysis) return;
            
            Object.entries(data.content_analysis).forEach(([format, analysis]) => {
                const div = document.createElement('div');
                div.className = 'meta-report-analysis-item';
                
                const spend = parseFloat(analysis.total_spend || 0);
                const impressions = parseInt(analysis.total_impressions || 0);
                const clicks = parseInt(analysis.total_clicks || 0);
                const engagement = parseInt(analysis.total_engagement || 0);
                const performanceScore = parseFloat(analysis.performance_score || 0);
                
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const engagementRate = impressions > 0 ? (engagement / impressions) * 100 : 0;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900">${format}</div>
                            <div class="text-xs text-gray-500">${analysis.campaign_count} campaigns</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">Score: ${performanceScore.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">CTR: ${ctr.toFixed(2)}%</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        Spend: ${VND_FMT.format(spend)} | Engagement: ${NUM_FMT.format(engagement)} (${engagementRate.toFixed(2)}%)
                    </div>
                `;
                
                contentList.appendChild(div);
            });
        }

        function createMetaReportCharts(data) {
            // Brand Chart
            if (data.brand_analysis) {
                const brandCtx = document.getElementById('brand-chart').getContext('2d');
                charts.brand && charts.brand.destroy();
                
                const brandEntries = Object.entries(data.brand_analysis).slice(0, 10);
                const brandLabels = brandEntries.map(([brand]) => brand);
                const brandSpend = brandEntries.map(([, analysis]) => parseFloat(analysis.total_spend || 0));
                
                charts.brand = new Chart(brandCtx, {
                    type: 'bar',
                    data: {
                        labels: brandLabels,
                        datasets: [{
                            label: 'Chi tiêu',
                            data: brandSpend,
                            backgroundColor: '#247ba0'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Content Format Chart
            if (data.content_analysis) {
                const contentCtx = document.getElementById('content-format-chart').getContext('2d');
                charts.contentFormat && charts.contentFormat.destroy();
                
                const contentEntries = Object.entries(data.content_analysis).slice(0, 10);
                const contentLabels = contentEntries.map(([format]) => format);
                const contentScores = contentEntries.map(([, analysis]) => parseFloat(analysis.performance_score || 0));
                
                charts.contentFormat = new Chart(contentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: contentLabels,
                        datasets: [{
                            data: contentScores,
                            backgroundColor: ['#247ba0', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Monthly Trends Chart
            if (data.monthly_data && data.monthly_data.length > 0) {
                const trendsCtx = document.getElementById('monthly-trends-chart').getContext('2d');
                charts.monthlyTrends && charts.monthlyTrends.destroy();
                
                const months = data.monthly_data.map(month => month.month);
                const spendData = data.monthly_data.map(month => parseFloat(month.spend || 0));
                const reachData = data.monthly_data.map(month => parseInt(month.reach || 0));
                const engagementData = data.monthly_data.map(month => parseInt(month.engagement || 0));
                
                charts.monthlyTrends = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Chi tiêu',
                                data: spendData,
                                borderColor: '#247ba0',
                                backgroundColor: 'rgba(36,123,160,0.1)',
                                tension: 0.3,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Reach',
                                data: reachData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16,185,129,0.1)',
                                tension: 0.3,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'Engagement',
                                data: engagementData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245,158,11,0.1)',
                                tension: 0.3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
        }

        function exportMetaReportData() {
            if (!metaReportData || !metaReportData.monthly_data) {
                alert('Không có dữ liệu để export');
                return;
            }
            
            const rows = metaReportData.monthly_data.map(month => {
                const spend = parseFloat(month.spend || 0);
                const reach = parseInt(month.reach || 0);
                const impressions = parseInt(month.impressions || 0);
                const clicks = parseInt(month.clicks || 0);
                const engagement = parseInt(month.engagement || 0);
                const videoViews = parseInt(month.video_views || 0);
                const linkClicks = parseInt(month.link_clicks || 0);
                
                const ctr = impressions > 0 ? (clicks / impressions) * 100 : 0;
                const cpc = clicks > 0 ? spend / clicks : 0;
                const engagementRate = impressions > 0 ? (engagement / impressions) * 100 : 0;
                
                return {
                    'Tháng': month.month,
                    'Thương hiệu': month.brands ? month.brands.join(', ') : 'Unknown',
                    'Định dạng nội dung': month.content_formats ? month.content_formats.join(', ') : 'Unknown',
                    'Chiến dịch': month.campaign_count,
                    'Chi tiêu': spend,
                    'Reach': reach,
                    'Impressions': impressions,
                    'Clicks': clicks,
                    'CTR': ctr,
                    'CPC': cpc,
                    'Engagement': engagement,
                    'Engagement Rate': engagementRate,
                    'Video Views': videoViews,
                    'Link Clicks': linkClicks
                };
            });
            
            const csv = toCSV(rows);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meta-report-insights-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Wire buttons
        document.addEventListener('DOMContentLoaded',()=>{
            let currentCampaign='';
            const patchView=window.viewInsights;
            function highlight(kind){
                const a=document.getElementById('btn-break-placement');
                const b=document.getElementById('btn-break-age');
                const c=document.getElementById('btn-break-country');
                [a,b,c].forEach(x=>{ if(!x) return; x.classList.remove('btn-primary','text-white'); x.style.backgroundColor=''; x.style.color='#247ba0'; x.classList.add('border'); });
                const map={placement:a,age_gender:b,country:c};
                const btn=map[kind]; if(btn){ btn.classList.remove('border'); btn.classList.add('btn-primary','text-white'); btn.style.color='#fff'; }
            }
            function applyFilters(data){
                const fs=document.getElementById('filter-status').value;
                const fo=document.getElementById('filter-objective').value;
                let items=data.campaigns.slice();
                if(fs!=='ALL') items=items.filter(x=>x.status===fs);
                if(fo!=='ALL') items=items.filter(x=>x.objective===fo);
                updateCampaignsTable(items);
                createCharts(items);
            }
            // populate objective options after load
            const oldLoad=window.loadAdsData;
            window.loadAdsData=async ()=>{ await oldLoad(); if(!adsData||!adsData.campaigns) return; const sel=document.getElementById('filter-objective'); const set=[...new Set(adsData.campaigns.map(c=>c.objective))]; sel.innerHTML='<option value="ALL" selected>Tất cả</option>'+set.map(o=>`<option value="${o}">${o}</option>`).join(''); applyFilters(adsData); }
            document.getElementById('filter-status').onchange=()=>applyFilters(adsData);
            document.getElementById('filter-objective').onchange=()=>applyFilters(adsData);
            document.getElementById('btn-export-campaigns').onclick=()=>{ const rows=(adsData?.campaigns||[]).map(c=>({id:c.campaign_id,name:c.campaign_name,status:c.status,objective:c.objective,created:c.created_time,start:c.start_time,stop:c.stop_time})); const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='campaigns.csv'; a.click(); URL.revokeObjectURL(url); };
            
            // AI Analysis button
            document.getElementById('btn-ai-analysis').onclick = () => {
                if (currentCampaign) {
                    // Disable button during analysis
                    const btn = document.getElementById('btn-ai-analysis');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = 'Đang phân tích...';
                    
                    performAIAnalysis(currentCampaign).finally(() => {
                        // Re-enable button
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
                } else {
                    alert('Vui lòng chọn một campaign trước khi phân tích AI');
                }
            };
            
            window.viewInsights=async (campaignId,status)=>{
                currentCampaign=campaignId; 
                resetAIState(); // Reset AI state when viewing new campaign
                await patchView(campaignId,status);
                const note=document.getElementById('insights-note'); if(note){ note.classList.add('hidden'); note.textContent=''; }
                const load=(kind)=>{ highlight(kind); const box=document.getElementById('breakdownChart').parentElement; box.classList.add('animate-pulse'); fetchBreakdown(currentCampaign,kind).then(d=>{ box.classList.remove('animate-pulse'); if(d.token_expired){ alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); return; } if(!d.error) renderBreakdown(kind,d.rows||[]); else console.warn('Breakdown error', d.error); }); };
                document.getElementById('btn-break-placement').onclick=()=>load('placement');
                document.getElementById('btn-break-age').onclick=()=>load('age_gender');
                document.getElementById('btn-break-country').onclick=()=>load('country');
                document.getElementById('date-preset').onchange=()=>{ const v=document.getElementById('date-preset').value; const show=v==='custom'; ['since','until','range-sep','apply-range'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.classList.toggle('hidden',!show);} }); if(!show){ load('placement'); fetchAds(currentCampaign).then(d=>{ if(!d.error) renderCreatives(d.items||[]); }); } };
                document.getElementById('apply-range').onclick=()=>{ load('placement'); fetchAds(currentCampaign).then(d=>{ if(d.token_expired){ alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); return; } if(!d.error) renderCreatives(d.items||[]); }); };
                load('placement');
                fetchAds(currentCampaign).then(d=>{ if(d.token_expired){ alert('Access token đã hết hạn. Vui lòng cập nhật USER_TOKEN/.env và reload.'); return; } if(!d.error) renderCreatives(d.items||[]); })
            }
        })
    </script>
</body>
</html>
